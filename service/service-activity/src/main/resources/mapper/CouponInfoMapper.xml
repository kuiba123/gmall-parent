<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper SYSTEM "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.atguigu.gmall.activity.mapper.CouponInfoMapper">

    <resultMap id="CouponInfoMap" type="com.atguigu.gmall.model.activity.CouponInfo" autoMapping="true">

    </resultMap>


    <!--查询普通优惠奍-->
    <select id="selectCouponInfoList" resultMap="CouponInfoMap">
        SELECT
            info.id,
            info.coupon_name,
            info.coupon_type,
            info.condition_amount,
            info.condition_num,
            info.activity_id,
            info.benefit_amount,
            info.benefit_discount,
            info.create_time,
            info.range_type,
            info.limit_num,
            info.range_desc,
            info.taken_count,
            info.start_time,
            info.end_time,
            info.operate_time,
            info.expire_time,
            IFNULL(cuse.id, 0) AS isGet,
            cuse.coupon_status AS couponStatus
        FROM
            coupon_info info
        INNER JOIN coupon_range crange ON info.id = crange.coupon_id
        LEFT JOIN coupon_use cuse ON info.id = cuse.coupon_id
        AND cuse.user_id = #{userId}
        WHERE
            (
                (
                    crange.range_type = 'SPU'
                    AND crange.range_id = #{spuId}
                )
                OR (
                    crange.range_type = 'CATAGORY'
                    AND crange.range_id = #{category3Id}
                )
                OR (
                    crange.range_type = 'TRADEMARK'
                    AND crange.range_id = #{tmId}
                )
            )
        AND now() BETWEEN info.start_time
        AND info.end_time
        AND info.activity_id IS NULL

        ORDER BY
            info.benefit_amount DESC,
            info.benefit_discount ASC;
    </select>

    <!--查询活动优惠劵-->
    <select id="selectActivityCouponInfoList" resultMap="CouponInfoMap">
        SELECT
            info.id,
            info.coupon_name,
            info.coupon_type,
            info.condition_amount,
            info.condition_num,
            info.activity_id,
            info.benefit_amount,
            info.benefit_discount,
            info.create_time,
            info.range_type,
            info.limit_num,
            info.range_desc,
            info.taken_count,
            info.start_time,
            info.end_time,
            info.operate_time,
            info.expire_time,
            IFNULL(cuse.id, 0) AS isGet,
            cuse.coupon_status AS couponStatus
        FROM
            coupon_info info
        INNER JOIN coupon_range crange ON info.id = crange.coupon_id
        LEFT JOIN coupon_use cuse ON info.id = cuse.coupon_id
        AND cuse.user_id = #{userId}
        where
            (
                (
                    crange.range_type = 'SPU'
                    AND crange.range_id = #{spuId}
                )
                OR (
                    crange.range_type = 'CATAGORY'
                    AND crange.range_id = #{category3Id}
                )
                OR (
                    crange.range_type = 'TRADEMARK'
                    AND crange.range_id = #{tmId}
                )
            )
        AND now() BETWEEN info.start_time
        AND info.end_time
        AND info.activity_id = #{activityId}
        ORDER BY
            info.benefit_amount DESC,
            info.benefit_discount ASC;
    </select>

    <select id="selectPageByUserId" resultMap="CouponInfoMap">
        select
            info.id,
            info.coupon_name,
            info.coupon_type,
            info.condition_amount,
            info.condition_num,
            info.activity_id,
            info.benefit_amount,
            info.benefit_discount,
            info.create_time,
            info.range_type,
            info.limit_num,
            info.range_desc,
            info.taken_count,
            info.start_time,
            info.end_time,
            info.operate_time,
            info.expire_time,
            cuse.coupon_status as couponStatus
        from
        coupon_info info
        inner join coupon_use cuse on info.id = cuse.coupon_id
        where cuse.user_id=#{userId}
        order by cuse.id desc
    </select>

    <select id="selectCartCouponInfoList" resultMap="CouponInfoMap">
        SELECT
            info.id,
            info.coupon_name,
            info.coupon_type,
            info.condition_amount,
            info.condition_num,
            info.activity_id,
            info.benefit_amount,
            info.benefit_discount,
            info.create_time,
            info.range_type,
            info.limit_num,
            info.range_desc,
            info.taken_count,
            info.start_time,
            info.end_time,
            info.operate_time,
            info.expire_time,
            crange.range_id AS rangeId,
            IFNULL(cuse.id, 0) AS isGet,
            cuse.coupon_status AS couponStatus
        FROM
            coupon_info info
        INNER JOIN coupon_range crange ON crange.coupon_id = info.id
        LEFT JOIN coupon_use cuse ON cuse.coupon_id = info.id
        AND cuse.user_id = #{userId}
        <where>
            <foreach collection="skuInfoList" item="item" index="index" open="(" separator="or" close=")">
                (
                (crange.range_type = 'SPU' and crange.range_id = #{item.spuId})
                or (crange.range_type = 'CATAGORY' and crange.range_id = #{item.category3Id})
                or (crange.range_type = 'TRADEMARK' and crange.range_id = #{item.tmId})
                )
            </foreach>
            and now() between info.start_time and info.end_time
        </where>
        order by info.condition_amount desc, info.benefit_discount desc
    </select>

    <select id="selectTradeCouponInfoList" resultMap="CouponInfoMap">
        SELECT
            info.id,
            info.coupon_name,
            info.coupon_type,
            info.condition_amount,
            info.condition_num,
            info.activity_id,
            info.benefit_amount,
            info.benefit_discount,
            info.create_time,
            info.range_type,
            info.limit_num,
            info.range_desc,
            info.taken_count,
            info.start_time,
            info.end_time,
            info.operate_time,
            info.expire_time,
            crange.range_id AS rangeId
        FROM
            coupon_use cuse
        INNER JOIN coupon_info info ON cuse.coupon_id = info.id
        INNER JOIN coupon_range crange ON crange.coupon_id = info.id
        <where>
            <foreach collection="skuInfoList" item="item" index="index" open="(" separator="or" close=")">
                (
                (crange.range_type = 'SPU' and crange.range_id = #{item.spuId})
                or (crange.range_type = 'CATAGORY' and crange.range_id = #{item.category3Id})
                or (crange.range_type = 'TRADEMARK' and crange.range_id = #{item.tmId})
                )
            </foreach>
            and cuse.user_id = #{userId}
            and cuse.coupon_status = 'NOT_USED'
            and info.expire_time >= now()
        </where>
        order by info.condition_amount desc, info.benefit_discount desc
    </select>
</mapper>